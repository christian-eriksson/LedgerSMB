<?lsmb#   This is a comment block; it's ignored by the template engine.

   Version:  1.2@1.9
   Date:     2022-03-26
   File:     dynatable.csv
   Set:      none; shared

Template version numbers are explicitly not aligned across templates or
releases. No explicit versioning was applied before 2021-01-04.

-?>
<?lsmb- BLOCK do_quote ;
IF VALUE.to_output.defined();
  value = VALUE.to_output();
ELSE;
  value = VALUE;
END;

IF value.match('[^0-9.+-]'); # any non-digit means run escaping
   '"'; value.replace('"', '""'); '"'; # " balance the double quotes
ELSE;
   value;
END;

END;

BLOCK dynatable;
SKIP_TYPES = ['hidden', 'radio', 'checkbox'];

FOREACH COL IN columns;
    IF 0 == SKIP_TYPES.grep(COL.type).size();
        IF ADD_COMMA;
           ',';
        END;
        INCLUDE do_quote VALUE = COL.name;
        ADD_COMMA = 1;
    END;
END;
?>
<?lsmb FOREACH ROW IN tbody.rows;

ADD_COMMA=0;

    FOREACH COL IN columns;
        COL_ID = COL.col_id;
        IF 0 == SKIP_TYPES.grep(COL.type).size();
            IF ADD_COMMA;
               ',';
            END;
            ADD_COMMA = 1;
            INCLUDE do_quote VALUE = ROW.$COL_ID;
        END;
    END; 
?>
<?lsmb END; END ?>
